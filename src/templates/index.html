<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0">
  <link rel="preconnect"
        href="https://fonts.googleapis.com">
  <link rel="preconnect"
        href="https://fonts.gstatic.com"
        crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
  <title>
    DP monitoring
  </title>

  <script src="/static/plotly-2.35.0.min.js"
          charset="utf-8"></script>

  <style>
    body {
      font-family: 'Raleway', sans-serif;
      margin: 0 auto;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #3a3a3a;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    #graph {
      width: calc(100% - 120px);
      height: 840px;
    }

    .graph-container {
      display: flex;
      padding-top: 20px;
      padding-bottom: 20px;
      background-color: #474747;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin: 20px;
      width: calc(100% - 120px);
    }

    .svg-container {
      width: calc(100% - 40px);
    }

    .header {
      width: 100%;
      padding-top: 20px;
      padding-bottom: 20px;
      color: white;
      font-size: 26px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      background-color: #474747;
    }
  </style>
</head>

<body>
  <div class="header">
    <div style="padding-left: 20px;">
      DP 2024-25 - Sebastián Čambál
    </div>
  </div>
  <div class="graph-container">
    <div id="graph"></div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 0) grab our plot DIV
      const graphDiv = document.getElementById('graph');
  
      // 1) load the JSON data that Jinja templated in
      const graphData = {{ graph_json | safe }};
  
      // 2) build the retraining trace and append to the data
      const retrainTrace = {
        x: graphData.data[0].x,
        y: new Array(graphData.data[0].x.length).fill(null),
        mode: 'markers',
        marker: { symbol: 'triangle-up', size: 12, color: 'red' },
        name: 'Retraining'
      };
      graphData.data.push(retrainTrace);
  
      // 3) draw it once, then in the .then() we know graphDiv.data is populated
      Plotly.newPlot(graphDiv, graphData.data, graphData.layout).then(() => {
        // 4) only now read the length of the pred-trace you already have
        //    trace 1 === PM10pred, trace 3 === PM25pred, trace 5 === NO2pred
        let lastPredLen = graphDiv.data[1].x.length;
  
        // 5) start polling
        setInterval(updateGraph, 2000);
  
        function updateGraph() {
          fetch('/data')
            .then(r => r.json())
            .then(d => {
              if (!d?.dates?.length || d.dates.length < 2) return;
  
              // parse timestamps
              const dates = d.dates.map(ts => new Date(ts));
              const n     = dates.length;
              const last  = dates[n - 1];
              const prev  = dates[n - 2];
              const delta = last - prev;
              const next  = new Date(last.getTime() + delta);
  
              // always extend real‑measurement traces (0,2,4)
              const yReal = [d.PM10, d.PM25, d.NO2].map(a => a.slice(-1)[0]);
              Plotly.extendTraces(
                graphDiv,
                {
                  x: [ [last],   [last],   [last]   ],
                  y: [ [yReal[0]],[yReal[1]],[yReal[2]] ]
                },
                [0, 2, 4]
              );
  
              // only extend pred-traces (1,3,5) when new ones appear
              if (d.PM10pred.length > lastPredLen) {
                const yPred = [d.PM10pred, d.PM25pred, d.NO2pred].map(a => a.slice(-1)[0]);
                Plotly.extendTraces(
                  graphDiv,
                  {
                    x: [ [next],   [next],   [next]   ],
                    y: [ [yPred[0]],[yPred[1]],[yPred[2]] ]
                  },
                  [1, 3, 5]
                );
                lastPredLen = d.PM10pred.length;
              }
  
              // append retraining marker (trace 6)
              const yRetr = d.retraining?.slice(-1)[0] ?? null;
              Plotly.extendTraces(
                graphDiv,
                { x: [[last]], y: [[yRetr]] },
                [6]
              );
  
              // slide the live WINDOW_SIZE view
              const WINDOW_SIZE = 62;
              const firstIdx   = Math.max(0, n - WINDOW_SIZE);
              Plotly.relayout(graphDiv, {
                'xaxis.range': [ dates[firstIdx], next ]
              });
            })
            .catch(console.error);
        }
      });
    });
  </script>
</body>

</html>